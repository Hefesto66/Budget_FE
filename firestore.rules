rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regra para a coleção 'companies'
    // Um utilizador só pode ler ou escrever no seu próprio documento de empresa.
    match /companies/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Regra geral para coleções que pertencem a uma empresa
    function isOwner(companyId) {
      return request.auth.uid == companyId;
    }
    
    function isSuperUser() {
      return request.auth.token.superuser == true;
    }

    // Coleção de Clientes
    match /clients/{clientId} {
      allow create: if isOwner(request.resource.data.companyId);
      allow read, update, delete: if isOwner(resource.data.companyId) || isSuperUser();
    }

    // Coleção de Cotações (Quotes)
    match /quotes/{quoteId} {
      allow create: if isOwner(request.resource.data.companyId);
      allow read, update, delete: if isOwner(resource.data.companyId) || isSuperUser();
    }
    
    // Coleção de Oportunidades (Leads)
    match /leads/{leadId} {
      allow create: if isOwner(request.resource.data.companyId);
      allow read, update, delete: if isOwner(resource.data.companyId) || isSuperUser();
    }
    
    // Coleção de Inventário
    match /inventory/{productId} {
       allow create: if isOwner(request.resource.data.companyId);
       allow read, update, delete: if isOwner(resource.data.companyId) || isSuperUser();
    }
  }
}
